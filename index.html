<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <title>Spectroscopic Standards</title>
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
  </head>

  <select id="keys-dropdown"></select>
  <select id="items-dropdown"></select>

  <body>
    <div id="chart"></div>
  </body>

  <script>
    google.charts.load("current", { packages: ["corechart"] });
    google.charts.setOnLoadCallback(drawChart);
    // Global variable to cache parsed data
    var parsedData = null;

    function drawChart() {
      // Get the selected CSV file
      var csvFile = "esoxshooter/fEG274.dat";

      // Load the CSV file
      var loadData = function () {
        return fetch(csvFile)
          .then(function (response) {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.text();
          })
          .then(function (text) {
            // Parse the space-separated file
            var rows = text.split("\n");
            var data = new google.visualization.DataTable({
              cols: [
                { id: "wavelength", label: "Wavelength", type: "number" },
                { id: "flux", label: "Flux", type: "number" },
              ],
            });
            for (var i = 0; i < rows.length - 1; i++) {
              var cells = rows[i].split(/\s+/).map(function (x) {
                return parseFloat(x);
              });
              data.addRow(cells);
            }
            // Cache the parsed data
            parsedData = data;
            return data;
          })
          .catch(function (error) {
            console.error("Error loading CSV file:", error);
          });
      };

      // Create the chart
      var createChart = function (data) {
        var options = {
          title: "Eso XShooter EG274",
          width: 1024,
          height: 768,
        };
        var chart = new google.visualization.LineChart(
          document.getElementById("chart")
        );
        chart.draw(data, options);
      };

      // Check if parsed data is cached
      if (parsedData !== null) {
        createChart(parsedData);
      } else {
        loadData().then(createChart);
      }
    }

    var xhr = new XMLHttpRequest();
    xhr.open("GET", "designation_to_filename.json", true);
    xhr.onload = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var data = JSON.parse(xhr.responseText);

        var keys = Object.keys(data);
        var select = document.getElementById("keys-dropdown");

        for (var i = 0; i < keys.length; i++) {
          var option = document.createElement("option");
          option.text = keys[i];
          select.add(option);
        }
      }
    };
    xhr.send();

    var select = document.getElementById("items-dropdown");

    document.getElementById("keys-dropdown").addEventListener("change", function() {
      var key = this.value;
      var items = data[key];

      select.options.length = 0;

      for (var i = 0; i < items.length; i++) {
        var option = document.createElement("option");
        option.text = items[i];
        select.add(option);
      }
    });
  </script>
  >
</html>
